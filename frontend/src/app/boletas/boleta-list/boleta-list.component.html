<div class="boleta-list-container">

  <!-- ‚îÄ‚îÄ Hero Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="page-header">
    <div class="header-left">
      <div class="header-icon"><mat-icon>assignment</mat-icon></div>
      <div class="header-text">
        <h1>Boletas de Evaluaci√≥n</h1>
        <span class="header-subtitle">Gesti√≥n de instrumentos de calidad</span>
      </div>
    </div>
    <div class="header-actions">
      <span class="total-badge" *ngIf="!isLoading">{{ totalItems }} registros</span>
      <button mat-raised-button class="btn-nueva" (click)="crearBoleta()">
        <mat-icon>add_circle_outline</mat-icon>
        Nueva Boleta
      </button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Filtros ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="filtros-card">
    <div class="filtros-bar">
      <mat-form-field appearance="outline" class="filtro-busq">
        <mat-label>Buscar boleta</mat-label>
        <input matInput [(ngModel)]="busqueda"
               placeholder="Nombre, cliente..."
               (keyup.enter)="applyFiltros()">
        <mat-icon matSuffix style="cursor:pointer;color:#4F46E5" (click)="applyFiltros()">search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filtro-select">
        <mat-label>Estado</mat-label>
        <mat-select [(ngModel)]="filtroEstado" (selectionChange)="applyFiltros()">
          <mat-option value="">Todos</mat-option>
          <mat-option value="draft">Borrador</mat-option>
          <mat-option value="activa">Activa</mat-option>
          <mat-option value="archivada">Archivada</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filtro-select">
        <mat-label>Tipo</mat-label>
        <mat-select [(ngModel)]="filtroTipo" (selectionChange)="applyFiltros()">
          <mat-option value="">Todos</mat-option>
          <mat-option value="llamada">üìû Llamada</mat-option>
          <mat-option value="chat">üí¨ Chat</mat-option>
          <mat-option value="email">‚úâÔ∏è Email</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-stroked-button class="btn-limpiar"
              (click)="clearFiltros()"
              *ngIf="busqueda || filtroEstado || filtroTipo">
        <mat-icon>clear</mat-icon> Limpiar
      </button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner [diameter]="44"></mat-spinner>
    <span>Cargando boletas...</span>
  </div>

  <!-- ‚îÄ‚îÄ Tabla ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="table-container" *ngIf="!isLoading">
    <table mat-table [dataSource]="boletas" class="boletas-table">

      <!-- Nombre + Cliente -->
      <ng-container matColumnDef="nombre">
        <th mat-header-cell *matHeaderCellDef>Boleta</th>
        <td mat-cell *matCellDef="let b">
          <div class="nombre-cell">
            <span class="nombre-text">{{ b.nombre }}</span>
            <span class="cliente-sub">{{ b.cliente }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Cliente (hidden ‚Äî se muestra en nombre-cell) -->
      <ng-container matColumnDef="cliente">
        <th mat-header-cell *matHeaderCellDef>Cliente</th>
        <td mat-cell *matCellDef="let b">{{ b.cliente }}</td>
      </ng-container>

      <!-- Pa√≠s -->
      <ng-container matColumnDef="pais">
        <th mat-header-cell *matHeaderCellDef>Pa√≠s</th>
        <td mat-cell *matCellDef="let b">
          <span class="pais-text">{{ b.pais }}</span>
        </td>
      </ng-container>

      <!-- Tipo -->
      <ng-container matColumnDef="tipo_interaccion">
        <th mat-header-cell *matHeaderCellDef>Canal</th>
        <td mat-cell *matCellDef="let b">
          <span class="tipo-badge">{{ tipoLabel(b.tipo_interaccion) }}</span>
        </td>
      </ng-container>

      <!-- Estado -->
      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let b">
          <span class="estado-chip estado-{{ b.estado }}">{{ b.estado_label || b.estado }}</span>
        </td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let b">

          <button mat-icon-button class="action-btn" style="color:#4F46E5"
                  matTooltip="Editar datos" *ngIf="b.estado === 'borrador' || b.estado === 'draft'"
                  (click)="editarBoleta(b)">
            <mat-icon>edit</mat-icon>
          </button>

          <button mat-icon-button class="action-btn" style="color:#8B5CF6"
                  matTooltip="Editar estructura (segmentos y preguntas)" *ngIf="b.estado === 'borrador' || b.estado === 'draft'"
                  (click)="editarEstructura(b)">
            <mat-icon>schema</mat-icon>
          </button>

          <!-- Clonar: solo cuando est√° activa (publicada en producci√≥n) y NO hay borrador pendiente -->
          <button mat-icon-button class="action-btn" style="color:#8B5CF6"
                  matTooltip="Clonar para editar (crea borrador sin afectar evaluaciones en curso)"
                  *ngIf="b.estado === 'activa' && !b.borrador_version_id"
                  (click)="clonarYEditar(b)">
            <mat-icon>content_copy</mat-icon>
          </button>

          <!-- Editar borrador existente -->
          <button mat-icon-button class="action-btn" style="color:#F59E0B"
                  matTooltip="Editar borrador pendiente (versi√≥n sin publicar)" *ngIf="b.borrador_version_id"
                  (click)="editarBorrador(b)">
            <mat-icon>edit_note</mat-icon>
          </button>

          <button mat-icon-button class="action-btn" style="color:#6B7280"
                  matTooltip="Ver detalles" *ngIf="b.estado !== 'borrador' && b.estado !== 'draft'"
                  (click)="editarBoleta(b)">
            <mat-icon>visibility</mat-icon>
          </button>

          <button mat-icon-button class="action-btn" style="color:#10B981"
                  matTooltip="Activar boleta" *ngIf="b.estado === 'borrador' || b.estado === 'draft'"
                  (click)="publicarBoleta(b)">
            <mat-icon>cloud_upload</mat-icon>
          </button>

          <button mat-icon-button class="action-btn" style="color:#F59E0B"
                  matTooltip="Archivar" *ngIf="b.estado === 'publicada' || b.estado === 'activa'"
                  (click)="inactivarBoleta(b)">
            <mat-icon>pause_circle</mat-icon>
          </button>

          <button mat-icon-button class="action-btn" style="color:#10B981"
                  matTooltip="Reactivar boleta" *ngIf="b.estado === 'archivada' || b.estado === 'inactiva'"
                  (click)="reactivarBoleta(b)">
            <mat-icon>play_circle</mat-icon>
          </button>

          <button mat-icon-button class="action-btn" style="color:#EF4444"
                  matTooltip="Eliminar" *ngIf="b.estado === 'borrador' || b.estado === 'draft'"
                  (click)="eliminarBoleta(b)">
            <mat-icon>delete_outline</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <tr class="mat-mdc-row no-data-row" *matNoDataRow>
        <td class="mat-mdc-cell" [attr.colspan]="displayedColumns.length">
          <div class="no-data-state">
            <mat-icon>search_off</mat-icon>
            <h3>Sin resultados</h3>
            <p>No hay boletas que coincidan con los filtros aplicados</p>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <!-- Paginador -->
  <mat-paginator class="paginador"
    *ngIf="!isLoading && totalItems > perPage"
    [length]="totalItems"
    [pageSize]="perPage"
    [pageIndex]="currentPage - 1"
    [pageSizeOptions]="[10, 15, 25, 50]"
    showFirstLastButtons
    (page)="onPage($event)">
  </mat-paginator>

</div>
